<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>P2P File Sharing</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
      .progress-bar {
        transition: width 0.5s ease;
      }
      .modal {
        transition: opacity 0.25s ease;
      }
      body.modal-active {
        overflow-x: hidden;
        overflow-y: hidden !important;
      }
      /* Custom scrollbar for dark mode */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #2d3748;
      }
      ::-webkit-scrollbar-thumb {
        background: #4a5568;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #718096;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <div class="container mx-auto p-6">
      <!-- Header -->
      <div
        class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4"
      >
        <div>
          <h1 class="text-3xl font-bold text-blue-500">Hybrid P2P Network</h1>
          <p class="text-sm text-gray-400">
            Status:
            <span id="status-indicator" class="text-green-400">Online</span>
          </p>
        </div>
        <div class="text-right">
          <p class="text-sm">
            Peer ID:
            <span id="peer-id" class="font-mono text-yellow-400"
              >Loading...</span
            >
          </p>
          <p class="text-xs text-gray-500">
            Port: <span id="peer-port">...</span>
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- LEFT COLUMN -->
        <div class="space-y-6">
          <!-- Search Section -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4 flex items-center">
              Search Network
            </h2>
            <div class="flex gap-2 mb-4">
              <input
                type="text"
                id="search-query"
                placeholder="Filename..."
                class="flex-1 p-2 rounded bg-gray-700 border border-gray-600 focus:outline-none focus:border-blue-500 text-white"
              />
              <button
                onclick="searchFiles()"
                class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded transition font-medium"
              >
                Search
              </button>
            </div>
            <div id="search-results" class="space-y-2 max-h-60 overflow-y-auto">
              <p class="text-gray-500 text-center text-sm">No results yet.</p>
            </div>
          </div>

          <!-- Share Section -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4 flex items-center">
              Share File
            </h2>
            <div class="flex gap-2 items-center">
              <input
                type="file"
                id="share-file-input"
                class="hidden"
                onchange="updateFileName()"
              />
              <label
                for="share-file-input"
                class="flex-1 cursor-pointer bg-gray-700 hover:bg-gray-600 text-gray-300 p-2 rounded border border-gray-600 truncate text-center transition"
              >
                <span id="file-name-display">Select a file...</span>
              </label>
              <button
                onclick="shareFile()"
                class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded transition text-white font-medium"
              >
                Share
              </button>
            </div>
          </div>

          <!-- My Files -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4">My Shared Files</h2>
            <ul
              id="my-files-list"
              class="text-sm text-gray-300 space-y-2 max-h-48 overflow-y-auto px-1"
            >
              <li>Loading...</li>
            </ul>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div class="space-y-6">
          <!-- Active Downloads -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4">Active Downloads</h2>
            <div
              id="active-downloads-list"
              class="space-y-3 max-h-60 overflow-y-auto"
            >
              <p class="text-gray-500 text-center text-sm">
                No active downloads.
              </p>
            </div>
          </div>

          <!-- Download History -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4">Downloaded Files</h2>
            <div
              id="download-history-list"
              class="space-y-3 max-h-60 overflow-y-auto"
            >
              <p class="text-gray-500 text-center text-sm">History is empty.</p>
            </div>
          </div>

          <!-- Reputation Table -->
          <div
            class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700"
          >
            <h2 class="text-xl font-semibold mb-4">
              Trust Score (My Reputation DB)
            </h2>
            <div class="overflow-x-auto">
              <table class="w-full text-sm text-left text-gray-400">
                <thead class="text-xs text-gray-200 uppercase bg-gray-700">
                  <tr>
                    <th class="px-4 py-2">Peer ID</th>
                    <th class="px-4 py-2">Score</th>
                    <th class="px-4 py-2">Interactions</th>
                  </tr>
                </thead>
                <tbody id="reputation-list">
                  <tr>
                    <td colspan="3" class="text-center py-2">No data.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- --- MODALS --- -->

    <!-- Info Modal -->
    <div
      id="info-modal"
      class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute w-full h-full bg-gray-900 opacity-75"
      ></div>
      <div
        class="modal-container bg-gray-800 w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto"
      >
        <div class="modal-content py-4 text-left px-6">
          <div class="flex justify-between items-center pb-3">
            <p class="text-2xl font-bold" id="modal-title">Info</p>
            <div
              class="cursor-pointer z-50"
              onclick="toggleModal('info-modal')"
            >
              âœ•
            </div>
          </div>
          <p id="modal-message">Message</p>
          <div class="flex justify-end pt-4">
            <button
              onclick="toggleModal('info-modal')"
              class="px-4 py-2 bg-blue-600 rounded text-white hover:bg-blue-500"
            >
              Close
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Download Settings Modal -->
    <div
      id="download-modal"
      class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50"
    >
      <div
        class="modal-overlay absolute w-full h-full bg-gray-900 opacity-75"
      ></div>
      <div
        class="modal-container bg-gray-800 w-11/12 md:max-w-lg mx-auto rounded shadow-lg z-50 overflow-y-auto"
      >
        <div class="modal-content py-4 text-left px-6">
          <div class="flex justify-between items-center pb-3">
            <p class="text-2xl font-bold">Download Options</p>
            <div
              class="cursor-pointer z-50"
              onclick="toggleModal('download-modal')"
            >
              âœ•
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-gray-400 text-sm font-bold mb-2"
              >Destination Folder</label
            >
            <div class="flex gap-2">
              <input
                class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline bg-gray-200"
                id="dest-path"
                type="text"
                placeholder="Default folder..."
              />
              <button
                onclick="browseFolder()"
                class="bg-gray-600 hover:bg-gray-500 text-white px-3 rounded text-sm"
              >
                Browse
              </button>
            </div>
            <p class="text-xs text-gray-500 mt-1">Leave empty for default.</p>
          </div>
          <input type="hidden" id="download-hash" />

          <div class="flex justify-end pt-4 gap-2">
            <button
              onclick="toggleModal('download-modal')"
              class="px-4 py-2 bg-gray-600 rounded text-white hover:bg-gray-500"
            >
              Cancel
            </button>
            <button
              onclick="confirmDownload()"
              class="px-4 py-2 bg-green-600 rounded text-white hover:bg-green-500"
            >
              Start Download
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      const socket = io();

      // --- Helpers ---
      function toggleModal(id) {
        const modal = document.getElementById(id);
        modal.classList.toggle("opacity-0");
        modal.classList.toggle("pointer-events-none");
        document.body.classList.toggle("modal-active");
      }
      function showInfo(t, m) {
        document.getElementById("modal-title").innerText = t;
        document.getElementById("modal-message").innerText = m;
        toggleModal("info-modal");
      }
      function formatSize(bytes) {
        if (bytes == 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }

      // --- Socket Listeners ---

      socket.on("status_update", (data) => {
        document.getElementById("peer-id").innerText = data.peer_id;
        document.getElementById("peer-port").innerText = data.port;
      });

      socket.on("reputation_update", (peers) => {
        const tbody = document.getElementById("reputation-list");
        if (peers.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="3" class="text-center py-2 text-gray-500">No interactions yet.</td></tr>';
          return;
        }
        tbody.innerHTML = peers
          .map(
            (p) => `
                <tr class="border-b border-gray-700 hover:bg-gray-700">
                    <td class="px-4 py-2 font-mono text-xs">${p.peer_id}</td>
                    <td class="px-4 py-2 text-${
                      p.score >= 10 ? "green" : p.score < 5 ? "red" : "yellow"
                    }-400">${p.score}</td>
                    <td class="px-4 py-2">${p.interactions}</td>
                </tr>
            `
          )
          .join("");
      });

      socket.on("downloads_update", (data) => {
        const activeDiv = document.getElementById("active-downloads-list");
        const historyDiv = document.getElementById("download-history-list");

        // Render Active
        const activeKeys = Object.keys(data.active);
        if (activeKeys.length === 0) {
          if (!activeDiv.innerHTML.includes("No active"))
            activeDiv.innerHTML =
              '<p class="text-gray-500 text-center text-sm">No active downloads.</p>';
        } else {
          activeDiv.innerHTML = activeKeys
            .map((hash) => {
              const info = data.active[hash];
              return `
                    <div class="bg-gray-700 p-3 rounded">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="truncate font-medium">${info.name}</span>
                            <span class="text-blue-400 text-xs">${info.status}</span>
                        </div>
                        <div class="w-full bg-gray-600 rounded-full h-2">
                            <div class="bg-blue-500 h-2 rounded-full progress-bar" style="width: ${info.progress}%"></div>
                        </div>
                    </div>`;
            })
            .join("");
        }

        // Render History
        if (data.history.length === 0) {
          if (!historyDiv.innerHTML.includes("History is empty"))
            historyDiv.innerHTML =
              '<p class="text-gray-500 text-center text-sm">History is empty.</p>';
        } else {
          historyDiv.innerHTML = data.history
            .map((info) => {
              // Escape path for JS string
              const safePath = info.final_path.replace(/\\/g, "\\\\");
              return `
                    <div class="bg-gray-700 p-3 rounded flex justify-between items-center">
                        <div class="truncate w-2/3">
                            <p class="font-medium truncate text-sm">${info.name}</p>
                            <p class="text-xs text-green-400">Completed</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openPath('${safePath}', true)" class="bg-blue-600 hover:bg-blue-500 text-xs px-2 py-1 rounded" title="Open File">File</button>
                            <button onclick="openPath('${safePath}', false)" class="bg-gray-600 hover:bg-gray-500 text-xs px-2 py-1 rounded" title="Open Folder">Folder</button>
                        </div>
                    </div>`;
            })
            .join("");
        }
      });

      // --- Actions ---

      function updateFileName() {
        const input = document.getElementById("share-file-input");
        const display = document.getElementById("file-name-display");
        display.textContent =
          input.files.length > 0 ? input.files[0].name : "Select a file...";
        display.classList.toggle("text-white", input.files.length > 0);
      }

      async function shareFile() {
        const input = document.getElementById("share-file-input");
        if (input.files.length === 0)
          return showInfo("Error", "Please select a file.");

        const formData = new FormData();
        formData.append("file", input.files[0]);

        // UI Feedback
        const btn = document.querySelector("button[onclick='shareFile()']");
        const oldText = btn.innerText;
        btn.innerText = "Uploading...";
        btn.disabled = true;

        try {
          const res = await fetch("/api/share", {
            method: "POST",
            body: formData,
          });
          const data = await res.json();
          showInfo(
            data.status === "success" ? "Success" : "Error",
            data.message
          );
          input.value = "";
          updateFileName();
          setTimeout(updateMyFiles, 2000);
        } catch (e) {
          showInfo("Error", e);
        } finally {
          btn.innerText = oldText;
          btn.disabled = false;
        }
      }

      async function searchFiles() {
        const q = document.getElementById("search-query").value;
        const res = await fetch(`/api/search?q=${q}`);
        const results = await res.json();
        const div = document.getElementById("search-results");

        if (results.length === 0) {
          div.innerHTML =
            '<p class="text-gray-500 text-center text-sm">No results found.</p>';
          return;
        }

        div.innerHTML = results
          .map(
            (f) => `
                <div class="flex justify-between items-center bg-gray-700 p-2 rounded hover:bg-gray-600 transition">
                    <div class="truncate w-2/3">
                        <p class="font-medium text-white truncate text-sm">${
                          f.name
                        }</p>
                        <p class="text-xs text-gray-400">${formatSize(
                          f.size
                        )} â€¢ Seeders: ${f.seeders}</p>
                    </div>
                    <button onclick="showDownloadModal('${
                      f.hash
                    }')" class="bg-blue-600 text-xs px-3 py-1 rounded hover:bg-blue-500">Download</button>
                </div>
            `
          )
          .join("");
      }

      function showDownloadModal(hash) {
        document.getElementById("download-hash").value = hash;
        document.getElementById("dest-path").value = "";
        toggleModal("download-modal");
      }

      async function browseFolder() {
        const res = await fetch("/api/browse_destination");
        const data = await res.json();
        if (data.status === "success") {
          document.getElementById("dest-path").value = data.path;
        }
      }

      async function confirmDownload() {
        const hash = document.getElementById("download-hash").value;
        const dest = document.getElementById("dest-path").value;
        toggleModal("download-modal");

        await fetch("/api/download", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ hash: hash, destination_path: dest }),
        });
        showInfo("Started", "Download started in background.");
      }

      async function openPath(path, isFile) {
        const res = await fetch("/api/open_path", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ path: path, is_file: isFile }),
        });
        const data = await res.json();
        if (data.status === "error") showInfo("Error", data.message);
      }

      async function updateMyFiles() {
        const res = await fetch("/api/my_files");
        const files = await res.json();
        document.getElementById("my-files-list").innerHTML = files
          .map(
            (f) =>
              `<li>ðŸ“„ ${
                f.name
              } <span class="text-gray-500 text-xs">(${formatSize(
                f.size
              )})</span></li>`
          )
          .join("");
      }

      updateMyFiles();
    </script>
  </body>
</html>
